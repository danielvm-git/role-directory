name: Promote Staging to Production

on:
  workflow_dispatch:
    inputs:
      staging_image_tag:
        description: 'Staging image tag to promote (e.g., staging-20231106-123456)'
        required: true
        type: string
      confirmation:
        description: 'Type PROMOTE_TO_PRODUCTION to confirm'
        required: true
        type: string

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: southamerica-east1
  SERVICE_NAME: role-directory-production

jobs:
  promote:
    name: Promote to Production
    runs-on: ubuntu-latest
    environment: production  # CRITICAL: Triggers approval requirement
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate confirmation
        run: |
          if [ "${{ inputs.confirmation }}" != "PROMOTE_TO_PRODUCTION" ]; then
            echo "âŒ Confirmation string does not match. Promotion cancelled."
            echo "Expected: PROMOTE_TO_PRODUCTION"
            echo "Received: ${{ inputs.confirmation }}"
            exit 1
          fi
          echo "âœ… Confirmation validated"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Pull staging image
        run: |
          STAGING_IMAGE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/role-directory/app:${{ inputs.staging_image_tag }}"
          echo "ğŸ“¦ Pulling staging image: $STAGING_IMAGE"
          docker pull $STAGING_IMAGE
          echo "âœ… Staging image pulled successfully"
          docker images | grep role-directory

      - name: Re-tag image for production
        id: retag
        run: |
          PRODUCTION_TAG="production-$(date +%Y%m%d-%H%M%S)"
          echo "PRODUCTION_TAG=$PRODUCTION_TAG" >> $GITHUB_OUTPUT
          
          STAGING_IMAGE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/role-directory/app:${{ inputs.staging_image_tag }}"
          PRODUCTION_IMAGE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/role-directory/app:$PRODUCTION_TAG"
          PRODUCTION_LATEST="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/role-directory/app:production-latest"
          
          echo "ğŸ·ï¸  Re-tagging image for production..."
          docker tag $STAGING_IMAGE $PRODUCTION_IMAGE
          docker tag $STAGING_IMAGE $PRODUCTION_LATEST
          
          echo "âœ… Tagged as: $PRODUCTION_TAG"
          echo "âœ… Tagged as: production-latest"

      - name: Push production images
        run: |
          PRODUCTION_IMAGE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/role-directory/app:${{ steps.retag.outputs.PRODUCTION_TAG }}"
          PRODUCTION_LATEST="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/role-directory/app:production-latest"
          
          echo "ğŸ“¤ Pushing production images to registry..."
          docker push $PRODUCTION_IMAGE
          docker push $PRODUCTION_LATEST
          echo "âœ… Production images pushed successfully"

      - name: Deploy to Cloud Run (Production)
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.GCP_REGION }}
          image: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/role-directory/app:${{ steps.retag.outputs.PRODUCTION_TAG }}
          flags: |
            --set-env-vars=NODE_ENV=production
            --min-instances=0
            --max-instances=2
            --cpu=1
            --memory=512Mi

      - name: Wait for deployment
        run: |
          echo "â³ Waiting for deployment to stabilize..."
          sleep 15
          echo "âœ… Deployment wait complete"

      - name: Health check
        run: |
          TOKEN=$(gcloud auth print-identity-token)
          PRODUCTION_URL="${{ steps.deploy.outputs.url }}"
          
          echo "ğŸ¥ Running health check against: $PRODUCTION_URL/api/health"
          echo "ğŸ“ Note: Production has min 2 instances (no cold start expected)"
          
          # Retry logic: Poll every 5 seconds for up to 60 seconds
          MAX_ATTEMPTS=12
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "ğŸ“¡ Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            START_TIME=$(date +%s%3N)
            RESPONSE=$(curl -f -s -w "\n%{http_code}" -H "Authorization: Bearer $TOKEN" "$PRODUCTION_URL/api/health" 2>&1 || true)
            END_TIME=$(date +%s%3N)
            RESPONSE_TIME=$((END_TIME - START_TIME))
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n-1)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed!"
              echo "Response: $BODY"
              echo "Response time: ${RESPONSE_TIME}ms"
              if [ $RESPONSE_TIME -lt 100 ]; then
                echo "âœ… Excellent response time (<100ms, no cold start)"
              fi
              exit 0
            fi
            
            echo "â³ Health check returned status $HTTP_CODE, retrying in 5 seconds..."
            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "âŒ Health check failed after $((MAX_ATTEMPTS * 5)) seconds"
          exit 1

      - name: Log promotion details
        if: always()
        run: |
          PRODUCTION_URL="${{ steps.deploy.outputs.url }}"
          
          # Generate unique token for stop-commands
          STOP_TOKEN=$(date +%s%N)
          
          echo "### ğŸš€ PRODUCTION Promotion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Environment:** PRODUCTION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Staging Image** | \`${{ inputs.staging_image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Production Image** | \`${{ steps.retag.outputs.PRODUCTION_TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run URL** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Use stop-commands to prevent URL masking
          echo "**ğŸŒ Production URL:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "::stop-commands::${STOP_TOKEN}"
          echo "${PRODUCTION_URL}" >> $GITHUB_STEP_SUMMARY
          echo "::${STOP_TOKEN}::"
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Backup: Code block with URL
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>ğŸ“‹ Copy URL (if masked above)</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "::stop-commands::${STOP_TOKEN}"
          echo "${PRODUCTION_URL}" >> $GITHUB_STEP_SUMMARY
          echo "::${STOP_TOKEN}::"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Status:** Promotion successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Promotion failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ PRODUCTION Promotion Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Staging Image:    ${{ inputs.staging_image_tag }}"
          echo "Production Image: ${{ steps.retag.outputs.PRODUCTION_TAG }}"
          echo "Production URL:   ${PRODUCTION_URL}"
          echo "Triggered by:     ${{ github.actor }}"
          echo "Timestamp:        $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Run URL:          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "âš ï¸  ENVIRONMENT: PRODUCTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

